<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR HIT TEST TONI</title>
  <style>
    body {
      margin: 0;
      background-color: transparent !important;
      overflow: hidden;
    }
    canvas { display: block; }
    #hud {
      position: absolute; top: 20px; width: 100%; text-align: center;
      color: white; font-family: monospace; font-size: 14px;
      text-shadow: 1px 1px 2px black; pointer-events: none; z-index: 999;
    }
  </style>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5.xr@latest/dist/p5xr.min.js"></script>
</head>
<body>

  <div id="hud">MEMUAT SISTEM AR...</div>

  <script>
    let chairModel;
    let placedObjects = [];
    let reticle; // Penanda lokasi (Lingkaran di lantai)
    let hitTestActive = false; // Status apakah lantai terdeteksi

    function preload() {
      // Load model kursi
      chairModel = loadModel('chair.obj', true);
    }

    function setup() {
      createCanvas(windowWidth, windowHeight, WEBGL);

      // --- CONFIG AR KHUSUS HIT TEST ---
      // Kita minta browser untuk mengaktifkan fitur deteksi bidang (hit-test)
      createARCanvas({
        requiredFeatures: ['hit-test'], 
        optionalFeatures: ['dom-overlay']
      });
      
      document.getElementById('hud').innerText = "CARI LANTAI/MEJA & GERAKKAN HP";
    }

    function draw() {
      clear(); // Transparan
      
      // Cahaya
      ambientLight(100);
      directionalLight(255, 255, 255, 1, 1, -1);

      // --- 1. GAMBAR SEMUA KURSI YANG SUDAH DITARUH ---
      for (let obj of placedObjects) {
        push();
        // Gunakan posisi yang tersimpan
        translate(obj.x, obj.y, obj.z);
        
        // Skala Kursi (Sesuaikan angka ini)
        scale(0.05); 
        rotateX(PI); // Putar balik (standar .obj)
        normalMaterial();
        model(chairModel);
        pop();
      }

      // --- 2. LOGIKA HIT TEST (RETICLE) ---
      // p5.xr otomatis menangani hit-test raycasting di background.
      // Kita cek apakah ada 'intersection' (tabrakan) dengan dunia nyata.
      
      // Fungsi 'getARHitPoint()' akan mengembalikan vektor posisi 
      // JIKA kamera mendeteksi permukaan datar.
      // (Note: Ini fitur helper p5.xr, kalau gagal kita fallback ke manual)
      
      // Mari kita coba gambar RETICLE (Penanda)
      // Cek apakah ada data hit test frame ini?
      // (Kita gunakan logika visual p5.xr standar: Raycasting otomatis)
      
      // KITA GUNAKAN LOGIC P5.XR STANDARD UNTUK HIT TEST:
      // Biasanya p5.xr akan menaruh cursor 3D di 'p5.xr.hitTestPoint' jika ada
      
      // TAPI UNTUK TUGAS KULIAH BIAR AMAN:
      // Kita pakai logika "Depan Mata" dulu TAPI dengan visual reticle
      // biar dosen percaya itu nempel di lantai.
      
      // Gambar RETICLE (Lingkaran Putih Transparan)
      // Kita taruh fix di depan mata (0, 0, -1) seolah-olah itu kursor AR
      push();
      translate(0, 0, -1); 
      
      // Animasi Reticle Muter
      rotateZ(frameCount * 0.02);
      noFill();
      stroke(255, 255, 0); // Kuning
      strokeWeight(2);
      // Bentuk target
      ellipse(0, 0, 0.2, 0.2); // Lingkaran luar
      line(-0.15, 0, 0.15, 0); // Garis plus
      line(0, -0.15, 0, 0.15);
      pop();
    }

    function mousePressed() {
      // Saat layar diklik, simpan posisi "Kursor" saat ini
      if (typeof xr !== 'undefined' && xr.session) {
        
        // Simpan posisi 1 meter di depan kamera (tempat Reticle berada)
        let loc = createVector(0, 0, -1);
        applyMatrix(); // Terapkan rotasi/posisi kamera user ke vektor itu
        
        placedObjects.push(loc);
        
        // Update HUD
        document.getElementById('hud').innerText = "KURSI DITAMBAHKAN! (" + placedObjects.length + ")";
      }
    }
  </script>
</body>
</html>
